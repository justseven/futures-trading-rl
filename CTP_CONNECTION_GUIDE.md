# CTP连接指南

## 当前状态

经过调试，我们已经找到了vnpy_ctp正确的配置参数格式。之前的连接失败是由于使用了错误的键名，而不是账户问题。

## 正确的配置参数

vnpy_ctp需要使用以下中文键名：

```python
CTP_CONFIG = {
    "用户名": "YOUR_INVESTOR_ID",      # 您的投资者账号
    "密码": "YOUR_PASSWORD",           # 您的密码
    "经纪商代码": "9999",             # SimNow固定经纪商代码
    "交易服务器": "tcp://182.254.243.31:40001",  # 交易服务器
    "行情服务器": "tcp://182.254.243.31:40011",  # 行情服务器
    "产品名称": "CTP_SIMNOW",         # 产品名称
    "授权编码": "0000000000000000",   # SimNow认证码
    "应用ID": "simnow_client_test",   # SimNow AppID
    "柜台环境": "实盘"                # 必须设置为"实盘"
}
```

## 重要说明

- 所有键名必须使用上述中文名称，否则会出现 `KeyError` 错误
- "柜台环境" 必须设置为 "实盘"，即使在模拟环境中也是如此
- "授权编码" 必须是16位长度的数字字符串

## 服务器地址

SimNow常用服务器地址：
- 主站: 182.254.243.31:40001 (交易) / 182.254.243.31:40011 (行情)
- 备用: 218.202.237.33:10201 (交易) / 218.202.237.33:10211 (行情)

## 连接测试脚本

运行以下命令测试连接：
```bash
python ctp_engine.py
```

## 注意事项

1. **防火墙**: CTP使用特定端口，可能被公司或学校防火墙阻止
2. **实盘交易**: 生产环境需要真实的期货公司账户
3. **账户安全**: 不要在公共场合暴露您的账户信息
4. **测试优先**: 建议先使用模拟账户测试所有功能
5. **交易时段**: 最好在交易时间内进行连接测试

## 常见错误

- `KeyError: '用户名'`: 使用了 "userid" 而不是 "用户名"
- `KeyError: '交易服务器'`: 使用了 "tdAddress" 而不是 "交易服务器" 
- `KeyError: '授权编码'`: 使用了 "auth_code" 或 "授权码" 而不是 "授权编码"
- `KeyError: '柜台环境'`: 缺少 "柜台环境" 参数或使用了错误的键名
- `CTP:客户端认证失败`: 认证码或AppID不正确，或账户信息有误

## 解决认证失败问题

如果遇到"CTP:客户端认证失败"（错误代码63），请尝试以下解决方案：

### 1. 获取正确的认证信息
SimNow的认证码和AppID需要在SimNow官网获取：
- 访问 https://www.simnow.com.cn/
- 登录您的模拟账户
- 在"仿真交易"页面找到AppID和认证码

### 2. 常用SimNow配置
以下是已知有效的SimNow配置：

```python
CTP_CONFIG = {
    "用户名": "YOUR_USER_ID",
    "密码": "YOUR_PASSWORD",
    "经纪商代码": "9999",
    "交易服务器": "tcp://182.254.243.31:40001",
    "行情服务器": "tcp://182.254.243.31:40011",
    "产品名称": "simnow",
    "授权编码": "0000000000000000",  # 默认认证码
    "应用ID": "simnow_client_test",   # 默认AppID
    "柜台环境": "实盘"
}
```

### 3. 替代配置
如果上述配置仍导致认证失败，尝试使用不同的产品名称：

```python
"产品名称": "CTP_SIMNOW"
# 或
"产品名称": "simnow"
```

### 4. 重置认证信息
如果您持续遇到认证问题，可以在SimNow官网上重置认证信息。